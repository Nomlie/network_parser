digraph DataLoader_Flow {
  rankdir=TB;
  labelloc="t";
  fontsize=20;
  fontname="Helvetica,Arial,sans-serif";
  label="DataLoader (data_loader.py) — Simplified Process Flow";
  node [shape=box, style="rounded,filled", fontname="Helvetica,Arial,sans-serif", fontsize=11, penwidth=1.1];
  edge [fontname="Helvetica,Arial,sans-serif", fontsize=10, penwidth=1.2, arrowsize=0.9];

  // ───────────────────────────────────────────────
  // Initialization
  // ───────────────────────────────────────────────
  init [label=<
    <B>DataLoader</B><BR/>
    Setup: bcftools check,<BR/>
    temp dir, config
  >, fillcolor="#e8f0ff"];

  // ───────────────────────────────────────────────
  // Main Entry Point
  // ───────────────────────────────────────────────
  entry [label=<
    <B>load_genomic_matrix</B><BR/>
    Dispatches by file type
  >, fillcolor="#fdfdff"];
  init -> entry;

  // Input branches (shown as separate paths, no direct arrows from entry)
  csv [label=<
    <B>CSV/TSV path</B><BR/>
    → pandas read
  >, fillcolor="#e6ffe6"];

  fasta [label=<
    <B>FASTA path</B><BR/>
    (placeholder)
  >, fillcolor="#ffe8d0"];

  vcf_single [label=<
    <B>Single VCF</B><BR/>
    → bcftools pipeline
  >, fillcolor="#fff0e0"];

  vcf_folder [label=<
    <B>Folder of VCFs</B><BR/>
    → index + merge → pipeline
  >, fillcolor="#fff0e0"];

  // ───────────────────────────────────────────────
  // Folder handling (simplified)
  // ───────────────────────────────────────────────
  index_merge [label=<
    <B>Index + Merge</B><BR/>
    • tabix on all .vcf.gz (if needed)<BR/>
    • bcftools merge → merged.vcf.gz<BR/>
    • tabix index merged
  >, fillcolor="#f0f4ff"];
  vcf_folder -> index_merge -> vcf_single [label="merged VCF"];

  // ───────────────────────────────────────────────
  // Core bcftools pipeline
  // ───────────────────────────────────────────────
  pipe [label=<
    <B>bcftools pipeline</B><BR/>
    Clean + process VCF
  >, fillcolor="#fff0e0"];
  vcf_single -> pipe;

  norm [label=<
    <B>Normalize</B><BR/>
    bcftools norm -f ref
  >, fillcolor="#e8f0ff"];

  biallelic [label=<
    <B>Split multi-allelic</B><BR/>
    norm -m-
  >, fillcolor="#e8f0ff"];

  qc_var [label=<
    <B>Variant QC</B><BR/>
    QUAL, DP filters
  >, fillcolor="#fff0e0"];

  qc_gt [label=<
    <B>Genotype QC</B><BR/>
    GQ/DP → missing
  >, fillcolor="#d8e8ff"];

  filter [label=<
    <B>Filters</B><BR/>
    • remove invariants (opt)<BR/>
    • missingness + MAF (opt)
  >, fillcolor="#fff0e0"];

  stats_anno [label=<
    <B>Stats &amp; Annotations</B><BR/>
    bcftools stats + query
  >, fillcolor="#fdfdff"];

  parse [label=<
    <B>Parse GTs</B><BR/>
    Streaming query → 0/1/NaN
  >, fillcolor="#fdfdff"];

  matrix [label=<
    <B>Build Matrix</B><BR/>
    samples × variants<BR/>
    → CSV
  >, fillcolor="#e0ffe0"];

  // Linear main flow
  pipe -> norm -> biallelic -> qc_var -> qc_gt -> filter -> stats_anno -> parse -> matrix;

  // ───────────────────────────────────────────────
  // Final Outputs
  // ───────────────────────────────────────────────
  outputs [label=<
    <B>Outputs</B><BR/>
    • cleaned VCF.gz (+ .tbi)<BR/>
    • stats/annotations CSV<BR/>
    • genomic_matrix.csv
  >, fillcolor="#f0f8ff"];
  matrix -> outputs [label="generates"];

  // Very light alignment only (no global rank=same to avoid conflicts)
  {rank=same; norm biallelic}
  {rank=same; qc_var qc_gt}
}