digraph NetworkParserWorkflow {
  rankdir=TB;
  splines=ortho;
  nodesep=0.55;
  ranksep=0.9;
  compound=true;

  labelloc="t";
  fontsize=26;
  fontname="Arial,Helvetica,sans-serif";
  label="NetworkParser Workflow\nRaw data → statistically validated markers & interaction networks";

  node [shape=box, style="rounded,filled", fontname="Arial,Helvetica,sans-serif", fontsize=11, penwidth=1.2];
  edge [fontname="Arial,Helvetica,sans-serif", fontsize=10, penwidth=1.4, arrowsize=0.95, color="#555"];

  // ───────────────────────────────────────────────
  // INPUTS
  // ───────────────────────────────────────────────
  subgraph cluster_inputs {
    label="Inputs";
    labelloc="t";
    fontsize=14;
    style="rounded";
    color="lightgray";
    penwidth=1.2;

    VCF   [label=<<B>VCF / VCF.gz</B><BR/><FONT POINT-SIZE="10">raw variants</FONT>>, fillcolor="#e3f2fd"];
    CSV   [label=<<B>CSV / TSV</B><BR/><FONT POINT-SIZE="10">feature matrix</FONT>>, fillcolor="#e3f2fd"];
    FASTA [label=<<B>FASTA</B><BR/><FONT POINT-SIZE="10">reference / MSA (optional)</FONT>>, fillcolor="#e3f2fd"];

    {rank=same; VCF; CSV; FASTA;}
  }

  // ───────────────────────────────────────────────
  // STAGE 1: PREPROCESSING
  // ───────────────────────────────────────────────
  subgraph cluster_stage1 {
    label="1) Input & Preprocessing";
    labelloc="t";
    fontsize=14;
    style="rounded";
    color="#cfd8dc";
    penwidth=1.2;

    Loader [label=<<B>data_loader.py</B><BR/><FONT POINT-SIZE="10" ALIGN="LEFT">
• Load inputs / merge<BR ALIGN="LEFT"/>
• bcftools normalize / QC + index<BR ALIGN="LEFT"/>
• <B>Strict biallelic SNP filter</B><BR ALIGN="LEFT"/>
• Encode 0/1 (NaN → 0 downstream)<BR ALIGN="LEFT"/>
• Optional: consensus FASTA via bcftools consensus
</FONT>>, fillcolor="#fff3e0"];

    BcfFilters [label=<<B>bcftools filtering</B><BR/><FONT POINT-SIZE="10">quality / missingness / biallelic</FONT>>, fillcolor="#ffebee"];

    Matrix [label=<<B>Variant feature matrix</B><BR/><FONT POINT-SIZE="10">samples × variants (binary)</FONT>>, fillcolor="#e1f5fe"];

    Consensus [label=<<B>Consensus FASTA</B><BR/><FONT POINT-SIZE="10">optional, reference-aware</FONT>>, fillcolor="#e8f5e9", style="rounded,dashed"];
  }

  // ───────────────────────────────────────────────
  // STAGE 2: ALIGNMENT & CLEANING
  // ───────────────────────────────────────────────
  subgraph cluster_stage2 {
    label="2) Alignment & Cleaning";
    labelloc="t";
    fontsize=14;
    style="rounded";
    color="#cfd8dc";
    penwidth=1.2;

    Align [label=<<B>align & clean</B><BR/><FONT POINT-SIZE="10" ALIGN="LEFT">
• Match samples ↔ labels<BR ALIGN="LEFT"/>
• Drop invariant sites<BR ALIGN="LEFT"/>
• Ensure consistent feature space
</FONT>>, fillcolor="#f0f4c3"];
  }

  // ───────────────────────────────────────────────
  // STAGE 3: FEATURE DISCOVERY (PRE-TREE VALIDATION INCLUDED)
  // ───────────────────────────────────────────────
  subgraph cluster_stage3 {
    label="3) Feature Discovery";
    labelloc="t";
    fontsize=14;
    style="rounded";
    color="#cfd8dc";
    penwidth=1.2;

    StatFilter [label=<<B>Statistical filtering</B><BR/><FONT POINT-SIZE="10" ALIGN="LEFT">
• Chi² / Fisher association<BR ALIGN="LEFT"/>
• Multiple testing (FDR-BH)<BR ALIGN="LEFT"/>
• Keep statistically defensible features
</FONT>>, fillcolor="#ffe0b2"];

    Builder [label=<<B>decision_tree_builder.py</B><BR/><FONT POINT-SIZE="10" ALIGN="LEFT">
• Decision tree construction<BR ALIGN="LEFT"/>
• Root vs branch markers<BR ALIGN="LEFT"/>
• Path-based epistasis mining
</FONT>>, fillcolor="#ffecb3"];
  }

  // ───────────────────────────────────────────────
  // STAGE 4: POST-TREE VALIDATION
  // ───────────────────────────────────────────────
  subgraph cluster_stage4 {
    label="4) Statistical Validation";
    labelloc="t";
    fontsize=14;
    style="rounded";
    color="#cfd8dc";
    penwidth=1.2;

    Validator [label=<<B>statistical_validator.py</B><BR/><FONT POINT-SIZE="10" ALIGN="LEFT">
• Bootstrap stability (post-tree)<BR ALIGN="LEFT"/>
• Permutation tests (interactions)<BR ALIGN="LEFT"/>
• Confidence scoring / robustness
</FONT>>, fillcolor="#e8f5e9"];
  }

  // ───────────────────────────────────────────────
  // STAGE 5: INTEGRATION & EXPORT
  // ───────────────────────────────────────────────
  subgraph cluster_stage5 {
    label="5) Integration & Export";
    labelloc="t";
    fontsize=14;
    style="rounded";
    color="#cfd8dc";
    penwidth=1.2;

    Parser [label=<<B>network_parser.py</B><BR/><FONT POINT-SIZE="10">
rank features • build networks • export
</FONT>>, fillcolor="#f3e5f5"];

    Outputs [label=<<B>Outputs</B><BR/><FONT POINT-SIZE="10" ALIGN="LEFT">
• ranked feature report (json)<BR ALIGN="LEFT"/>
• interaction graph (GraphML)<BR ALIGN="LEFT"/>
• sample–feature network (GraphML)<BR ALIGN="LEFT"/>
• GNN-ready matrices (.npz)
</FONT>>, fillcolor="#e0f7fa"];
  }

  // ───────────────────────────────────────────────
  // DOWNSTREAM (OPTIONAL)
  // ───────────────────────────────────────────────
  Downstream [label=<<B>Downstream phylogeny</B><BR/><FONT POINT-SIZE="10">IQ-TREE / etc. (optional)</FONT>>, fillcolor="#e0f7fa", style="rounded,dashed"];

  // ───────────────────────────────────────────────
  // FLOW
  // ───────────────────────────────────────────────
  VCF   -> Loader;
  CSV   -> Loader;
  FASTA -> Loader;

  Loader -> BcfFilters [label="VCF path"];
  BcfFilters -> Matrix [label="encode"];
  BcfFilters -> Consensus [label="--ref-fasta", style=dashed, color="gray"];

  Loader -> Matrix [label="matrix path", style=dashed, color="gray"];

  Matrix -> Align -> StatFilter -> Builder -> Validator -> Parser -> Outputs;

  Consensus -> Downstream [style=dashed, color="gray"];
}
