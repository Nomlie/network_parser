digraph VCF_to_NetworkParser_Pipeline {
  rankdir=TB;
  splines=ortho;
  bgcolor="white";
  labelloc="t";
  fontsize=22;
  fontname="Helvetica,Arial,sans-serif";
  label="VCF → ML Matrix → NetworkParser Discovery Pipeline\n(Variant-centric → Sample-centric → Statistical + Tree-based Analysis)";

  node [
    shape=box,
    style="rounded,filled",
    fontname="Helvetica,Arial,sans-serif",
    fontsize=11,
    penwidth=1.2,
    width=4.0,
    height=0.6
  ];

  edge [
    fontname="Helvetica,Arial,sans-serif",
    fontsize=10,
    penwidth=1.3,
    arrowsize=1.0
  ];

  // ─── Color scheme ────────────────────────────────────────────
  // Input / Matrix     → blues/greens
  // Preprocessing      → warm yellow
  // Statistical steps  → soft red
  // Tree & Epistasis   → stronger red
  // Validation         → light orange (optional)

  VCF_Input [
    fillcolor="#E3F2FD",
    label=<<TABLE BORDER="0" CELLBORDER="0">
      <TR><TD><B>Input: VCF (variant-centric)</B></TD></TR>
      <TR><TD><FONT POINT-SIZE="10">Rows: variants • Columns: samples + FORMAT</FONT></TD></TR>
    </TABLE>>
  ];

  VCF_Example [
    fillcolor="#E8F5FF",
    label=<<TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0">
      <TR><TD COLSPAN="4"><B>Simplified VCF</B></TD></TR>
      <TR><TD></TD><TD><B>S1</B></TD><TD><B>S2</B></TD><TD><B>S3</B></TD></TR>
      <TR><TD><B>var1</B></TD><TD>0/1</TD><TD>0/0</TD><TD>./.</TD></TR>
      <TR><TD><B>var2</B></TD><TD>0/0</TD><TD>0/1</TD><TD>1/1</TD></TR>
    </TABLE>>
  ];

  Decomposition [
    fillcolor="#F5F5F5",
    shape=plaintext,
    fontsize=13,
    label=<<B>Decompose each variant row</B><BR/>1. Identity (CHROM:POS:REF:ALT)<BR/>2. Variant QC (QUAL/FILTER/DP/AC/…)<BR/>3. Sample genotypes (GT:DP:GQ:…)>
  ];

  Identity [
    fillcolor="#E8F5E9",
    label=<<B>Variant identity</B><BR/>&rarr; future feature name>
  ];

  VarQC [
    fillcolor="#FFF3E0",
    label=<<B>Variant-level annotations</B><BR/>QUAL, FILTER, MQ, AF, F_MISSING, …>
  ];

  SampleGT [
    fillcolor="#E3F2FD",
    label=<<B>Sample-level calls</B><BR/>GT (+ DP, GQ, AD, …)>
  ];

  // ─── Matrix Construction ──────────────────────────────────────

  SiteFilter [
    fillcolor="#FFECB3",
    label=<<B>Site filtering</B><BR/>Drop low-quality / low-call-rate variants>
  ];

  GT_Mask [
    fillcolor="#BBDEFB",
    label=<<B>Genotype masking</B><BR/>Low-confidence &rarr; . / NaN (GQ, DP thresholds)>
  ];

  DropInvariant [
    fillcolor="#FFECB3",
    label=<<B>Drop invariant sites</B><BR/>(no ALT in cohort) – optional>
  ];

  EncodeGT [
    fillcolor="#E8F5E9",
    label=<<B>Genotype encoding</B><BR/>0/0 &rarr; 0<BR/>het / hom-alt &rarr; 1<BR/>./. &rarr; NaN>
  ];

  ML_Matrix [
    fillcolor="#C8E6C9",
    label=<<TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0">
      <TR><TD COLSPAN="2"><B>Final ML matrix</B></TD></TR>
      <TR><TD>Rows</TD><TD>samples</TD></TR>
      <TR><TD>Columns</TD><TD>variants</TD></TR>
      <TR><TD>Values</TD><TD>0 / 1 / NaN</TD></TR>
    </TABLE>>
  ];

  // ─── NetworkParser Stages ─────────────────────────────────────

  Preprocessing [
    fillcolor="#FFECB3",
    label=<<B>Lightweight preprocessing</B><BR/>• Remove remaining invariants<BR/>• Simple missing imputation (&rarr; REF/0)<BR/>• Near-monomorphic filter (MAF threshold)>
  ];

  Prefilter [
    fillcolor="#FFCDD2",
    label=<<B>Statistical pre-filtering</B><BR/>χ² / Fisher • FDR-BH • min MAF / completeness>
  ];

  TreeBuild [
    fillcolor="#FFCDD2",
    label=<<B>Decision Tree Discovery</B><BR/>sklearn DecisionTreeClassifier<BR/>max_depth, min_samples…>
  ];

  TreeAnalyze [
    fillcolor="#FFCDD2",
    label=<<B>Tree structure analysis</B><BR/>Root vs branch features • depth / paths>
  ];

  Confidence [
    fillcolor="#FFCDD2",
    label=<<B>Confidence scoring</B><BR/>MI • bootstrap stability • Cramér’s V>
  ];

  Epistasis [
    fillcolor="#EF9A9A",
    label=<<B>Epistasis / synergy mining</B><BR/>Path-based pairs • MI synergy metric>
  ];

  // ─── Optional Validation ──────────────────────────────────────

  Validation [
    fillcolor="#FFE0B2",
    style="rounded,dashed",
    label=<<B>Optional Validation</B><BR/>Association tests • FDR • Bootstrap<BR/>Permutation tests for interactions>
  ];

  Outputs [
    fillcolor="#E8F5E9",
    label=<<B>Outputs</B><BR/>• Key variants / root features<BR/>• Epistatic candidates<BR/>• Confidence &amp; stability scores<BR/>• JSON reports + artifacts>
  ];

  // ─── Explicit vertical flow ───────────────────────────────────

  { rank=same; VCF_Input; VCF_Example }
  { rank=same; Decomposition }
  { rank=same; Identity; VarQC; SampleGT }

  VCF_Input     -> Decomposition;
  VCF_Input     -> VCF_Example   [style=invis];   // alignment helper

  Decomposition -> Identity;
  Decomposition -> VarQC;
  Decomposition -> SampleGT;

  VarQC         -> SiteFilter;
  SampleGT      -> GT_Mask;

  SiteFilter    -> DropInvariant [style=dashed];
  GT_Mask       -> EncodeGT;

  { rank=same; DropInvariant; EncodeGT }

  EncodeGT      -> ML_Matrix     [label="numeric values"];
  DropInvariant -> ML_Matrix     [style=dashed, label="kept variants"];
  Identity      -> ML_Matrix     [style=dashed, color="#777777", label="column names"];

  ML_Matrix     -> Preprocessing;
  Preprocessing -> Prefilter;

  Prefilter     -> TreeBuild;
  TreeBuild     -> TreeAnalyze;
  TreeAnalyze   -> Confidence;
  Confidence    -> Epistasis;

  Epistasis     -> Validation    [style=dashed, label="if enabled"];
  Epistasis     -> Outputs;
  Validation    -> Outputs       [style=dashed];
}